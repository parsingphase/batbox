{% extends 'tracemap/base.html' %}
{% load tracemap_extras %}
{% load static %}

{% block subtitle %}Search{% endblock %}
{% block head-css %}
    {{ block.super }}

    <!-- include input widgets; this is independent of Datepair.js -->
    <link rel="stylesheet" type="text/css" href="{% static 'css/jquery.timepicker.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'css/bootstrap-datepicker.css' %}"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
          integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
          crossorigin=""/>

    <style>
        form {
            margin-top: 10px;
        }

        .datepicker {
            z-index: 1500 !important;
        }
    </style>

{% endblock %}

{% block body-container %}
    {{ mapbox_token|json_script:"mapbox-token" }}
    <form id="searchParams">
        <div class="row">
            <div class="col-2">
                Time range
            </div>
            <div class="col-10">
                <div class="form-row" id="timeRange">
                    <div class="col">
                        <label for="dateStart">From date</label>
                        <input id="dateStart" type="text" class="date start form-control" placeholder="YYYY-MM-DD"/>
                    </div>
                    <div class="col">
                        <label for="timeStart">From time</label>
                        <input id="timeStart" type="text" class="time start form-control" placeholder="HH:MM"/></div>
                    <div class="col">
                        <label for="dateEnd">To date</label>
                        <input id="dateEnd" type="text" class="date end form-control" placeholder="YYYY-MM-DD"/></div>
                    <div class="col">
                        <label for="timeEnd">To time</label>
                        <input id="timeEnd" type="text" class="time end form-control" placeholder="HH:MM"/></div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-2">
                Species
            </div>
            <div class="col-10">
                <div class="form-row" id="">
                    {% for genus, species in genii.items %}
                        <div class="col">
                            {% if genus %}{{ genus }}{% else %}Unidentified{% endif %}
                            {% for s in species %}
                                <div>
                                    <input type="checkbox" checked="checked" id="species-{{ s }}"
                                           class="species" data-genus="{{ genus }}" data-species="{{ s }}"
                                           name="species[{{ s }}]" value="1"/>
                                    <label for="species-{{ s }}">{% if s %}{{ s }}{% else %} ? {% endif %}</label>
                                </div>
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-2">
                Area
            </div>
            <div class="col-10">
                <div class="form-row" id="">
                    <div id="map-target"
                         style="background-color: lightgray; width: 60%; margin-left: 20%; height: 300px;">
                        Map loadingâ€¦
                    </div>
                </div>
                <div class="form-row" id="geoRange">
                    <div class="col">
                        <label for="east">East</label>
                        <input type="number" class="form-control" id="east" min="-90" max="90" step="0.001"
                               placeholder="East"/>
                    </div>
                    <div class="col">
                        <label for="south">South</label>
                        <input type="number" class="form-control" id="south" min="-180" max="180" step="0.001"
                               placeholder="South"/>
                    </div>
                    <div class="col">
                        <label for="west">West</label>
                        <input type="number" class="form-control" id="west" min="-90" max="90" step="0.001"
                               placeholder="West"/>
                    </div>
                    <div class="col">
                        <label for="north">North</label>
                        <input type="number" class="form-control" id="north" min="-180" max="180" step="0.001"
                               placeholder="North"/>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-2">
                Search
            </div>
            <div class="col-10">
                <button class="btn btn-primary" type="button" id="searchTrigger">Search</button>
            </div>
        </div>
    </form>

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
            integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8=" crossorigin="anonymous"></script>

    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
            integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
            crossorigin=""></script>

    <script type="text/javascript" src="{% static 'js/bootstrap-datepicker.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/jquery.timepicker.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/datepair.js' %}"></script>


    <script type="module">
        import MapHandler from '{% static 'tracemap/js/MapHandler.js' %}';

        let map;

        /**
         * @type {Object}
         * @property {Array} traces
         * @property {Array} bounds
         */
        const mapboxToken = JSON.parse(document.getElementById('mapbox-token').textContent);
        map = new MapHandler('map-target', mapboxToken).drawMapWithView([0, 55], 12);

        /**
         *
         * @param {LatLngBounds} bounds
         */
        function updateGeoControls(bounds) {
            $('#south').val(Number(bounds.getSouth()).toFixed(3));
            $('#west').val(Number(bounds.getWest()).toFixed(3));
            $('#north').val(Number(bounds.getNorth()).toFixed(3));
            $('#east').val(Number(bounds.getEast()).toFixed(3));
        }

        updateGeoControls(map.map.getBounds());

        map.map.on('moveend', function (e) {
            updateGeoControls(map.map.getBounds())
        });


    </script>

    <script>
        // https://github.com/jonthornton/jquery-timepicker
        // initialize input widgets first
        $('#timeRange .time').timepicker({
            'showDuration': true,
            'timeFormat': 'H:i',
            'orientation': 'rb',
            'step': 5,
        });

        $('#timeRange .date').datepicker({
            'format': 'yyyy-mm-dd',
            'autoclose': true
        });

        // initialize datepair
        var timeRangeEl = document.getElementById('timeRange');
        var datepair = new Datepair(timeRangeEl);

        const form = $('#searchParams');
        form.find('input').change(scanForm);

        function scanForm() {
            const data = {};
            data.timeRange = {
                dateStart: form.find('#dateStart').val(),
                timeStart: form.find('#timeStart').val(),
                dateEnd: form.find('#dateEnd').val(),
                timeEnd: form.find('#timeEnd').val(),
            };
            data.species = [];
            form.find('input.species').each(
                function () {
                    let t = $(this);
                    if (t.prop('checked')) {
                        data.species.push(t.data('species'))
                    }
                }
            );
            const geoForm = form.find('#geoRange');
            data.geoRange = {
                'east': geoForm.find('#east').val(),
                'south': geoForm.find('#south').val(),
                'west': geoForm.find('#west').val(),
                'north': geoForm.find('#north').val(),
            };

            console.log(data);
            return data;
        }

        function doSearch() {
            console.log('Search');
            let data = scanForm();
        }

        $('#searchTrigger').click(doSearch);
    </script>
{% endblock %}