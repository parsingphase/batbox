{% extends 'tracemap/base.html' %}
{% load static %}

{% block subtitle %}{% if title %}{{ title }}{% else %}List View{% endif %}{% endblock %}

{% block head-css %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% static 'vendor/css/jquery.dataTables.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'vendor/css/leaflet.css' %}"/>
{% endblock %}


{% block body-container %}
    {{ map_data|json_script:"map-data" }}
    {{ mapbox_token|json_script:"mapbox-token" }}

    {% if title %}<h1>{{ title }}</h1>{% endif %}

    <div id="map-target" style="width: 100%; height: 400px; background-color: lightgray">
        <div class="map-loader" style="margin: auto">loading mapâ€¦</div>
    </div>

    <table id="recordingsTable" class="table table-striped recordings">
    </table>
    <script type="text/javascript" src="{% static 'vendor/js/jquery.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendor/js/jquery.dataTables.min.js' %}"></script>
    <script type="text/javascript" charset="utf8" src="{% static 'vendor/js/moment.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'vendor/js/leaflet.js' %}"></script>

    <script type="module">
        import MapHandler from '{% static 'tracemap/js/MapHandler.js' %}';

        let map;

        /**
         * @type {Object}
         * @property {Array} traces
         * @property {Array} bounds
         */
        const mapData = JSON.parse(document.getElementById('map-data').textContent);
        const mapboxToken = JSON.parse(document.getElementById('mapbox-token').textContent);

        if (mapData.bounds) {
            map = new MapHandler('map-target', mapboxToken)
                .drawMapWithBounds(mapData.bounds)
                .addAudioMarkers(mapData.traces);
        } else {
            $('.map-loader').text('No positioned files available');
        }
        const recordings = mapData.traces;
        let tableTarget = 'recordingsTable';

        import ListHandler from '{% static 'tracemap/js/ListHandler.js' %}';

        const listTable = new ListHandler(tableTarget, map);
        listTable.initTable(recordings);

    </script>
{% endblock %}