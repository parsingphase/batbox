{% extends 'tracemap/base.html' %}
{% load tracemap_extras %}

{% block head-css %}
    {{ block.super }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
          integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
          crossorigin=""/>
{% endblock %}

{% block subtitle %}Recordings {{ title }}{% endblock %}

{% block body-container %}
    {{ map_data|json_script:"map-data" }}

    <div class="row">
        <h1>Recordings {{ title }}</h1>
    </div>
    <div class="row">
        <div class="col col-sm-8" id="map-pane">
            <div id="map-target" style="width: 100%; height: 700px; background-color: lightgray"></div>
        </div>
        <div class="col col-sm-4" id="audio-pane">
            {% for file in files %}
                {#                {{ file.as_serializable }}#}
                <div class="card">
                    <div class="card-body" id="recording-{{ file.identifier }}">
                        <h5 class="card-title">{{ file.identifier }}</h5>
                        <a href="{{ MEDIA_URL }}{{ file.file|relpath:MEDIA_ROOT }}"><i class="fas fa-download"></i></a>
                        <a href="javascript:playSample('{{ file.identifier }}')"><i class="fas fa-play"></i></a>
                        {% if file.latitude %}
                            <a href="javascript:panTo('{{ file.identifier }}')"><i
                                    class="fas fa-map-marker-alt"></i></a>
                        {% endif %}
                        <br/>
                        Genus: {{ file.genus }}<br/>
                        Species: {{ file.species }}<br/>
                        Time:
                        {% if file.recorded_at %}
                            {{ file.recorded_at|date:'SHORT_DATETIME_FORMAT' }}
                        {% else %}
                            Unknown
                        {% endif %}<br/>
                        Location:
                        {% if file.latitude %}
                            {{ file.latitude|floatformat:3 }}, {{ file.longitude|floatformat:3 }}
                        {% else %}
                            Unknown
                        {% endif %}
                        <audio id="audio-{{ file.identifier }}">
                            <source src="{{ MEDIA_URL }}{{ file.file|relpath:MEDIA_ROOT }}" type="audio/wav">
                        </audio>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
            integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
            crossorigin=""></script>
    <script>
        var mapData = JSON.parse(document.getElementById('map-data').textContent);

        var map = L.map('map-target').fitBounds(mapData.bounds);
        {#var tileset = 'mapbox.streets';#}
        var tilesets = ['mapbox.streets', 'mapbox.satellite'];
        var tileset = tilesets[1];

        for (var s = 0; s < tilesets.length; s++) {
            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: tileset,
                accessToken: '{{ mapbox_token }}'
            }).addTo(map);
        }

        function playSample(name) {
            document.getElementById('audio-' + name).play();
        }

        var markers = {};
        var marker;
        for (let i = 0; i < mapData.traces.length; i++) {
            let trace = mapData.traces[i];
            let id = trace.identifier;
            marker = L.marker(trace.latlon).addTo(map);
            marker.bindPopup('<a href="#recording-' + trace.identifier + '">' + trace.identifier + '</a>');
            markers[id] = marker;

        }

        function panTo(ident) {
            if (markers.hasOwnProperty(ident)) {
                map.panTo(markers[ident].getLatLng());
                markers[ident].openPopup();
                document.getElementById('map-pane').scrollIntoView();
            }
        }

    </script>
{% endblock %}
